# CLAHE 优化方案设计文档：4-Bank 交织存储架构

## 1. 概述
本文档详细介绍了将基于 FPGA 的 CLAHE（限制对比度自适应直方图均衡化）实现从 **4x4 (16 tiles)** 扩展到 **8x8 (64 tiles)** 配置的优化策略。

主要的挑战在于：在提高分块分辨率（以增强局部对比度细节）的同时，避免 FPGA BRAM 资源的爆炸式增长，并保持 1 像素/周期的处理吞吐率。

## 2. 理论基础：VLSI 数字信号处理系统
本优化策略基于 Keshab K. Parhi 的著作《VLSI Digital Signal Processing Systems》中的原理，特别是 **硬件折叠 (Hardware Folding)** 和 **存储器交织 (Memory Interleaving)** 技术。

### 2.1 硬件折叠 (架构层级)
*   **问题**：如果采用直接映射（展开架构），64 个 Tile 需要 64 个独立的物理 RAM 块，效率极低且资源消耗大。
*   **解决方案**：应用 **硬件折叠** 技术，折叠因子 $N=16$。
    *   **逻辑节点**：64 个独立的 Tile。
    *   **物理资源**：4 个独立的 RAM Bank。
    *   **映射关系**：每个物理 Bank 负责存储 16 个逻辑 Tile 的数据。
    *   **资源收益**：RAM 块使用量减少了 93.75%（从 64 个减少到 4 个）。

### 2.2 存储器交织 (访问层级)
*   **问题**：双线性插值算法要求在一个时钟周期内同时访问 4 个相邻的逻辑 Tile（左上、右上、左下、右下）。
*   **解决方案**：实施基于空间奇偶性的 **棋盘式交织 (Checkerboard Interleaving)** 方案。
    *   该方案确保网格上任意 $2 \times 2$ 的滑动窗口 **总是** 覆盖 4 个不同的 Bank (0, 1, 2, 3)。
    *   **无冲突访问**：从数学上保证了插值期间的存储器访问零冲突 (Zero Conflict)。

## 3. 实现细节

### 3.1 4-Bank 交织存储架构
Tile 坐标 $(x, y)$ 到 Bank $B$ 的映射公式为：
$$B(x, y) = (x \pmod 2) \times 2 + (y \pmod 2)$$

| Bank ID | Tile 坐标 $(x, y)$ 示例 |
| :--- | :--- |
| **Bank 0** | (0,0), (0,2), (2,0), (2,2), ... |
| **Bank 1** | (1,0), (1,2), (3,0), (3,2), ... |
| **Bank 2** | (0,1), (0,3), (2,1), (2,3), ... |
| **Bank 3** | (1,1), (1,3), (3,1), (3,3), ... |

### 3.2 读端交叉开关 (Read Crossbar)
由于随着窗口滑动，“左上角”Tile 的物理位置会发生变化，因此在读路径上引入了一个轻量级的 **交叉开关 (Crossbar Switch)**。
*   **输入**：来自 Bank 0-3 的 4 路数据流。
*   **控制**：由当前 `tile_x` 和 `tile_y` 的最低有效位 (LSB) 决定。
*   **输出**：重排序后的 `CDF_TL`, `CDF_TR`, `CDF_BL`, `CDF_BR` 数据流。

### 3.3 强度削减 (算术优化)
我们使用硬件代价更低的操作替换昂贵的算术操作，以最小化逻辑面积。

#### A. 坐标计算
避免使用硬件除法 ($x / TileWidth$) 进行索引计算。
*   **优化**：使用 **比较器链** 进行区间判断。
    ```verilog
    if (x < 160) tile_x = 0;
    else if (x < 320) tile_x = 1; ...
    ```
    *   **优势**：零精度损失，面积显著小于除法器。

#### B. 插值权重
避免使用硬件除法 ($dist / Width$) 进行权重计算。
*   **优化**：使用预计算倒数的 **移位-加法 (Shift-Add)** 操作。
    *   目标公式：`Weight = (Distance * 256) / 160`
    *   实现公式：`Weight = (Distance * 1638) >> 10`
    *   其中 $1638 \approx (256/160) \times 1024$。
    *   **优势**：用单个乘法器和位移替换了除法。最大量化误差 < 0.05 个灰度级，人眼完全不可见。

## 4. 性能总结

| 指标 | 原始方案 (4x4) | 优化方案 (8x8) | 说明 |
| :--- | :--- | :--- | :--- |
| **逻辑 Tile 数** | 16 | 64 | **细节提升 4 倍** |
| **RAM 使用量** | 16 Banks | 4 Banks | **较原始方案减少 75%** |
| **吞吐率** | 1 像素/周期 | 1 像素/周期 | **无性能损失** |
| **流水线级数** | 5 级 | 5 级 | 保持不变 |
| **复杂度** | 低 | 低+ (增加 Crossbar) | 逻辑开销可忽略 |

## 5. 结论
本设计成功地将 **逻辑算法复杂度**（Tile 数量）与 **物理硬件复杂度**（RAM 数量）解耦。通过利用 VLSI DSP 的折叠和交织技术，我们实现了一个既资源高效又具备高性能的 8x8 CLAHE 设计。
